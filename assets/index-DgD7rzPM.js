var m=Object.defineProperty;var h=(s,e,t)=>e in s?m(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>(h(s,typeof e!="symbol"?e+"":e,t),t);import{d as l,f as u,g as f,c as p,a as g,o as S}from"./index-CtmtGOSL.js";class E{constructor(){a(this,"baseURL");a(this,"mediaSegments");a(this,"mediaSourceObject");a(this,"_currentSegment");a(this,"videoSourceBuffer");a(this,"audioSourceBuffer");this.mediaSourceObject=new MediaSource,this._currentSegment=0,this.baseURL="https://playertest.longtailvideo.com/adaptive/bipbop/gear4/",this.mediaSourceObject.addEventListener("sourceopen",this.onSourceOpen.bind(this)),this.mediaSegments=[]}get currentSegment(){return this._currentSegment}set currentSegment(e){this._currentSegment=e}get mediaSourceReadyState(){return this.mediaSourceObject.readyState}get mediaSourceBuffered(){return this.mediaSourceObject.sourceBuffers}get mediaSourceBufferedLength(){return this.mediaSourceObject.sourceBuffers.length}onBufferUpdateEnd(){this.loadSegment(this.videoSourceBuffer),this.videoSourceBuffer.updating==!1&&this.mediaSourceObject.readyState=="open"&&this.mediaSourceObject.endOfStream()}async loadSegment(e){if(this.currentSegment>=this.mediaSegments.length-1)return;const t=this.mediaSegments[this.currentSegment],n=await fetch(`${this.baseURL}${t.uri}`).then(i=>i.arrayBuffer());e.appendBuffer(n),this.currentSegment++}async onSourceOpen(){if(!this.mediaSourceObject||this.videoSourceBuffer)return;const e=this.mediaSourceObject.addSourceBuffer('video/mp2t; codecs="avc1.42E01E"');e.timestampOffset=-10,await this.loadSegment(e),e.addEventListener("updateend",this.onBufferUpdateEnd.bind(this)),this.videoSourceBuffer=e}appendSegments(e){this.mediaSegments=e}}class v extends EventTarget{constructor(t){super();a(this,"_mediaElement");a(this,"_streamer");a(this,"canvasElement");this.canvasElement=t,this._mediaElement=document.createElement("video"),this._streamer=new E,this._mediaElement.addEventListener("play",this.onPlayer.bind(this)),this._mediaElement.controls=!0,this._bindMediaEvents()}_bindMediaEvents(){["play","pause","ended","timeupdate"].forEach(n=>{console.log(this._mediaElement),this._mediaElement.addEventListener(n,()=>{this.dispatchEvent(new Event(n))})})}onPlayer(){const t=this.canvasElement.getContext("2d"),n=()=>{t==null||t.drawImage(this._mediaElement,0,0,this.canvasElement.width,this.canvasElement.height),requestAnimationFrame(n)};requestAnimationFrame(n)}initMediaElement(){this._mediaElement.src=URL.createObjectURL(this._streamer.mediaSourceObject),this._mediaElement.autoplay=!0,this._mediaElement.controls=!0,this._mediaElement.muted=!0}appendSegments(t){this._streamer.appendSegments(t),this.initMediaElement()}}function _(s){return fetch(s).then(n=>n.text())}function y(s){const e=s.split(`
`),t=[];for(let n=0;n<e.length;n++){let i=e[n];if(i.startsWith("#EXTINF")){const c=/#EXTINF:(\d+(?:\.\d+)?),/.exec(i),o=c?parseFloat(c[1]):null;let r=n+1;for(;r<e.length&&e[r].startsWith("#");)r+=1;const d=r<e.length?e[r]:null;o!==null&&d&&t.push({duration:o,uri:d})}}return t}async function b(s){const e=await _(s);return y(e)}async function B(s){const e=new v(s),t=await b("https://playertest.longtailvideo.com/adaptive/bipbop/gear4/prog_index.m3u8");return e.appendSegments(t),e._mediaElement}const j=l({__name:"index",setup(s){const e=u(null),t=u(null);return f(async()=>{var i;const n=e.value;if(n){const c=await B(n);(i=t.value)==null||i.append(c)}}),(n,i)=>(S(),p("section",{class:"huh-player",ref_key:"section",ref:t},[g("canvas",{class:"canvas",ref_key:"huhPlayer",ref:e,width:"640",height:"360"},null,512)],512))}});export{j as default};
